var Login = function () {
    localStorage.setItem(globalURLEnlaceme, 'http://localhost/www.enlaceme.com/');
    var globalURLEnlaceme = localStorage.getItem(globalURLEnlaceme);
	var handleLogin = function() {
		$('.login-form').validate({
	            errorElement: 'span', //default input error message container
	            errorClass: 'help-block', // default input error message class
	            focusInvalid: false, // do not focus the last invalid input
	            rules: {
	                username: {
	                    required: true
	                },
	                password: {
	                    required: true
	                },
	                remember: {
	                    required: false
	                }
	            },
	            messages: {
	                username: {
	                    required: "Username is required."
	                },
	                password: {
	                    required: "Password is required."
	                }
	            },
	            invalidHandler: function (event, validator) { //display error alert on form submit   
	                $('.alert-danger', $('.login-form')).show();
	            },
	            highlight: function (element) { // hightlight error inputs
	                $(element)
	                    .closest('.form-group').addClass('has-error'); // set error class to the control group
	            },
	            success: function (label) {
	                label.closest('.form-group').removeClass('has-error');
	                label.remove();
	            },
	            errorPlacement: function (error, element) {
	                error.insertAfter(element.closest('.input-icon'));
	            },
	            submitHandler: function (form) {
	                form.submit();
	            }
	        });
	        $('.login-form input').keypress(function (e) {
	            if (e.which == 13) {
	                if ($('.login-form').validate().form()) {
	                    $('.login-form').submit();
	                }
	                return false;
	            }
	        });
	}
	var handleForgetPassword = function () {
		$('.forget-form').validate({
	            errorElement: 'span', //default input error message container
	            errorClass: 'help-block', // default input error message class
	            focusInvalid: false, // do not focus the last invalid input
	            ignore: "",
	            rules: {
	                email: {
	                    required: true,
	                    email: true
	                }
	            },
	            messages: {
	                email: {
	                    required: "Email is required."
	                }
	            },
	            invalidHandler: function (event, validator) { //display error alert on form submit   
	            },
	            highlight: function (element) { // hightlight error inputs
	                $(element)
	                    .closest('.form-group').addClass('has-error'); // set error class to the control group
	            },
	            success: function (label) {
	                label.closest('.form-group').removeClass('has-error');
	                label.remove();
	            },
	            errorPlacement: function (error, element) {
	                error.insertAfter(element.closest('.input-icon'));
	            },
	            submitHandler: function (form) {
	                form.submit();
	            }
	        });
	        $('.forget-form input').keypress(function (e) {
	            if (e.which == 13) {
	                if ($('.forget-form').validate().form()) {
	                    $('.forget-form').submit();
	                }
	                return false;
	            }
	        });
	        jQuery('#forget-password').click(function () {
	            jQuery('.login-form').hide();
	            jQuery('.forget-form').show();
	        });
	        jQuery('#back-btn').click(function () {
	            jQuery('.login-form').show();
	            jQuery('.forget-form').hide();
	        });
	}
    var handleRegister = function () {
                function format(state) {
            if (!state.id) { return state.text; }
            var $state = $(
             '<span><img src="assets/pages/images/flags/' + state.element.value.toLowerCase() + '.png" class="img-flag" /> ' + state.text + '</span>'
            );
            return $state;
        }
        if (jQuery().select2 && $('#country_list').size() > 0) {
            $("#country_list").select2({
                placeholder: '<i class="fa fa-map-marker"></i>&nbsp;Select a Country',
                templateResult: format,
                templateSelection: format,
                width: 'auto', 
                escapeMarkup: function(m) {
                    return m;
                }
            });
            $('#country_list').change(function() {
                $('.register-form').validate().element($(this)); //revalidate the chosen dropdown value and show error or success message for the input
            });
        }
         $('.register-form').validate({
                errorElement: 'span', //default input error message container
                errorClass: 'help-block', // default input error message class
                focusInvalid: false, // do not focus the last invalid input
                ignore: "",
                rules: {
                    fullname: {
                        required: true
                    },
                    email: {
                        required: true,
                        email: true
                    },
                    address: {
                        required: true
                    },
                    city: {
                        required: true
                    },
                    country: {
                        required: true
                    },
                    username: {
                        required: true
                    },
                    password: {
                        required: true
                    },
                    rpassword: {
                        equalTo: "#register_password"
                    },
                    tnc: {
                        required: true
                    }
                },
                messages: { // custom messages for radio buttons and checkboxes
                    tnc: {
                        required: "Please accept TNC first."
                    }
                },
                invalidHandler: function (event, validator) { //display error alert on form submit   
                },
                highlight: function (element) { // hightlight error inputs
                    $(element)
                        .closest('.form-group').addClass('has-error'); // set error class to the control group
                },
                success: function (label) {
                    label.closest('.form-group').removeClass('has-error');
                    label.remove();
                },
                errorPlacement: function (error, element) {
                    if (element.attr("name") == "tnc") { // insert checkbox errors after the container                  
                        error.insertAfter($('#register_tnc_error'));
                    } else if (element.closest('.input-icon').size() === 1) {
                        error.insertAfter(element.closest('.input-icon'));
                    } else {
                        error.insertAfter(element);
                    }
                },
                submitHandler: function (form) {
                    form.submit();
                }
            });
            $('.register-form input').keypress(function (e) {
                if (e.which == 13) {
                    if ($('.register-form').validate().form()) {
                        $('.register-form').submit();
                    }
                    return false;
                }
            });
            jQuery('#register-btn').click(function () {
                jQuery('.login-form').hide();
                jQuery('.register-form').show();
            });
            jQuery('#register-back-btn').click(function () {
                jQuery('.login-form').show();
                jQuery('.register-form').hide();
            });
	}
    var handleFacebookLogin = function () {
            window.fbAsyncInit = function() {
                // FB JavaScript SDK configuration and setup
                FB.init({
                  appId      : '435644016851589', // FB App ID
                  cookie     : true,  // enable cookies to allow the server to access the session
                  xfbml      : true,  // parse social plugins on this page
                  version    : 'v2.12' // use graph api version 2.8
                });
                // Check whether the user already logged in
                FB.getLoginStatus(function(response) {
                    if(response.status === 'connected'){
                        //display user data
                        //alert(response.status);
                        //getFbUserData();
                    }/*/ else if(response.status === 'not_authorized'){
                        alert('Talvez por error quitaste los privilegios de acceso a Enlaceme.com desde Facebook, por favor vuelve a acceder.');
                    }*/
                });
            };
            // Load the JavaScript SDK asynchronously
            (function(d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = "//connect.facebook.net/en_US/sdk.js";
                fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
            // Facebook login with JavaScript SDK
            function fbLogin() {
                //alert('Login Facebook');
                FB.login(function(response) {
                    if(response.authResponse) {
                        // Get and display the user profile data
                        getFbUserData();
                    } else {
                        document.getElementById('status').innerHTML = 'User cancelled login or did not fully authorize.';
                    }
                }, {scope: 'email'});
            }
            // Fetch the user profile data from facebook
            function getFbUserData(){
                FB.api('/me', {locale: 'en_US', fields: 'id,first_name,last_name,email,link,gender,locale,picture.type(large)'},
                function(response) {
                    /*document.getElementById('fbLink').setAttribute("onclick","fbLogout()");
                    document.getElementById('fbLink').innerHTML = 'Logout from Facebook';
                    document.getElementById('status').innerHTML = 'Gracias por registrarse, ' + response.first_name + '!';
                    document.getElementById('userData').innerHTML = '<p><b>FB ID:</b> '+response.id+'</p><p><b>Name:</b> '+response.first_name+' '+response.last_name+'</p><p><b>Email:</b> '+response.email+'</p><p><b>Gender:</b> '+response.gender+'</p><p><b>Locale:</b> '+response.locale+'</p><p><b>Picture:</b> <img src="'+response.picture.data.url+'"/></p><p><b>FB Profile:</b> <a target="_blank" href="'+response.link+'">click to view profile</a></p>';*/
                    askIfFacebookUserExists(response);
                    //saveUserData(response);
                });
            }
            function askIfFacebookUserExists(facebookUserData){
                $.post(globalURLEnlaceme + 'access/facebookUserExists/', {facebookUserData : JSON.stringify(facebookUserData)}, function(responseFacebookUserExists){
                        if(responseFacebookUserExists == 0){
                            saveUserData(facebookUserData);
                        } else if(responseFacebookUserExists == 1){
                            facebookAccess(facebookUserData);
                        }
                    });
            }
            function saveUserData(facebookUserData){
                $.post(globalURLEnlaceme + 'access/facebookRegisterMethod/', {facebookUserData: JSON.stringify(facebookUserData)}, function(responseSaveUserData){
                        //alert('saveUserData: ' + responseSaveUserData);
                        if(responseSaveUserData == 'success'){
                            facebookAccess(facebookUserData);
                            //alert('Bienvenido a Enlaceme.com');
                            //window.location = globalURLEnlaceme + 'profile';
                        } else if(responseSaveUserData == 'fail'){
                            alert('UPS! ocurrio un problema, por favor intenta más tarde');
                        }
                    });
            }
            function facebookAccess(facebookUserData){
                $.post(globalURLEnlaceme + 'access/facebookLoginMethod/', {facebookUserData: JSON.stringify(facebookUserData)}, function(responseFacebookAccess){
                        //alert('saveUserData: ' + responseSaveUserData);
                        if(responseFacebookAccess == 'success'){
                            alert('Bienvenido a Enlaceme.com');
                            window.location = globalURLEnlaceme + 'account';
                        } else if(responseFacebookAccess == 'fail'){
                            alert('UPS! ocurrio un problema, por favor intenta más tarde');
                        }
                    });
            }        
            // Logout from facebook
            function fbLogout() {
                alert('Salir de Facebook');
                FB.logout();
            }
        
        $('#facebookLoginAccess').click(function(){
            alert('acceder con facebook'); 
            fbLogin().click();
        });
        
        $('#facebookLogOutAccess').click(function(){
            fbLogout().click();
        });        
        
    }
    return {
        //main function to initiate the module
        init: function () {
            handleLogin(), handleForgetPassword(), handleRegister(), handleFacebookLogin();
        }
    };
}();
jQuery(document).ready(function() {
    Login.init();
});